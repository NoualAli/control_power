"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[570],{5714:(t,e,s)=>{s.d(e,{ZP:()=>g,l0:()=>w});var r=s(9669),a=s.n(r),o=Object.defineProperty,i=Object.prototype.hasOwnProperty,n=Object.getOwnPropertySymbols,l=Object.prototype.propertyIsEnumerable,c=(t,e,s)=>e in t?o(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,d=(t,e)=>{for(var s in e||(e={}))i.call(e,s)&&c(t,s,e[s]);if(n)for(var s of n(e))l.call(e,s)&&c(t,s,e[s]);return t};const u=t=>void 0===t,m=t=>Array.isArray(t),f=t=>t&&"number"==typeof t.size&&"string"==typeof t.type&&"function"==typeof t.slice,p=(t,e,s,r)=>((e=e||{}).indices=!u(e.indices)&&e.indices,e.nullsAsUndefineds=!u(e.nullsAsUndefineds)&&e.nullsAsUndefineds,e.booleansAsIntegers=!u(e.booleansAsIntegers)&&e.booleansAsIntegers,e.allowEmptyArrays=!u(e.allowEmptyArrays)&&e.allowEmptyArrays,s=s||new FormData,u(t)||(null===t?e.nullsAsUndefineds||s.append(r,""):(t=>"boolean"==typeof t)(t)?e.booleansAsIntegers?s.append(r,t?1:0):s.append(r,t):m(t)?t.length?t.forEach(((t,a)=>{const o=r+"["+(e.indices?a:"")+"]";p(t,e,s,o)})):e.allowEmptyArrays&&s.append(r+"[]",""):(t=>t instanceof Date)(t)?s.append(r,t.toISOString()):!(t=>t===Object(t))(t)||(t=>f(t)&&"string"==typeof t.name&&("object"==typeof t.lastModifiedDate||"number"==typeof t.lastModified))(t)||f(t)?s.append(r,t):Object.keys(t).forEach((a=>{const o=t[a];if(m(o))for(;a.length>2&&a.lastIndexOf("[]")===a.length-2;)a=a.substring(0,a.length-2);p(o,e,s,r?r+"["+a+"]":a)}))),s);var v={serialize:p};function h(t){if(null===t||"object"!=typeof t)return t;const e=Array.isArray(t)?[]:{};return Object.keys(t).forEach((s=>{e[s]=h(t[s])})),e}function y(t){return Array.isArray(t)?t:[t]}function b(t){return t instanceof File||t instanceof Blob||t instanceof FileList||"object"==typeof t&&null!==t&&void 0!==Object.values(t).find((t=>b(t)))}class _{constructor(){this.errors={},this.errors={}}set(t,e){"object"==typeof t?this.errors=t:this.set(d(d({},this.errors),{[t]:y(e)}))}all(){return this.errors}has(t){return Object.prototype.hasOwnProperty.call(this.errors,t)}hasAny(...t){return t.some((t=>this.has(t)))}any(){return Object.keys(this.errors).length>0}get(t){if(this.has(t))return this.getAll(t)[0]}getAll(t){return y(this.errors[t]||[])}only(...t){const e=[];return t.forEach((t=>{const s=this.get(t);s&&e.push(s)})),e}flatten(){return Object.values(this.errors).reduce(((t,e)=>t.concat(e)),[])}clear(t){const e={};t&&Object.keys(this.errors).forEach((s=>{s!==t&&(e[s]=this.errors[s])})),this.set(e)}}class w{constructor(t={}){this.originalData={},this.busy=!1,this.successful=!1,this.recentlySuccessful=!1,this.recentlySuccessfulTimeoutId=void 0,this.errors=new _,this.progress=void 0,this.update(t)}static make(t){return new this(t)}update(t){this.originalData=Object.assign({},this.originalData,h(t)),Object.assign(this,t)}fill(t={}){this.keys().forEach((e=>{this[e]=t[e]}))}data(){return this.keys().reduce(((t,e)=>d(d({},t),{[e]:this[e]})),{})}keys(){return Object.keys(this).filter((t=>!w.ignore.includes(t)))}startProcessing(){this.errors.clear(),this.busy=!0,this.successful=!1,this.progress=void 0,this.recentlySuccessful=!1,clearTimeout(this.recentlySuccessfulTimeoutId)}finishProcessing(){this.busy=!1,this.successful=!0,this.progress=void 0,this.recentlySuccessful=!0,this.recentlySuccessfulTimeoutId=setTimeout((()=>{this.recentlySuccessful=!1}),w.recentlySuccessfulTimeout)}clear(){this.errors.clear(),this.successful=!1,this.recentlySuccessful=!1,this.progress=void 0,clearTimeout(this.recentlySuccessfulTimeoutId)}reset(){Object.keys(this).filter((t=>!w.ignore.includes(t))).forEach((t=>{this[t]=h(this.originalData[t])}))}get(t,e={}){return this.submit("get",t,e)}post(t,e={}){return this.submit("post",t,e)}patch(t,e={}){return this.submit("patch",t,e)}put(t,e={}){return this.submit("put",t,e)}delete(t,e={}){return this.submit("delete",t,e)}submit(t,e,s={}){return this.startProcessing(),s=d({data:{},params:{},url:this.route(e),method:t,onUploadProgress:this.handleUploadProgress.bind(this)},s),"get"===t.toLowerCase()?s.params=d(d({},this.data()),s.params):(s.data=d(d({},this.data()),s.data),b(s.data)&&!s.transformRequest&&(s.transformRequest=[t=>v.serialize(t)])),new Promise(((t,e)=>{(w.axios||a()).request(s).then((e=>{this.finishProcessing(),t(e)})).catch((t=>{this.handleErrors(t),e(t)}))}))}handleErrors(t){this.busy=!1,this.progress=void 0,t.response&&this.errors.set(this.extractErrors(t.response))}extractErrors(t){return t.data&&"object"==typeof t.data?t.data.errors?d({},t.data.errors):t.data.message?{error:t.data.message}:d({},t.data):{error:w.errorMessage}}handleUploadProgress(t){this.progress={total:t.total,loaded:t.loaded,percentage:Math.round(100*t.loaded/t.total)}}route(t,e={}){let s=t;return Object.prototype.hasOwnProperty.call(w.routes,t)&&(s=decodeURI(w.routes[t])),"object"!=typeof e&&(e={id:e}),Object.keys(e).forEach((t=>{s=s.replace(`{${t}}`,e[t])})),s}onKeydown(t){const e=t.target;e.name&&this.errors.clear(e.name)}}w.routes={},w.errorMessage="Something went wrong. Please try again.",w.recentlySuccessfulTimeout=2e3,w.ignore=["busy","successful","errors","progress","originalData","recentlySuccessful","recentlySuccessfulTimeoutId"];const g=w},570:(t,e,s)=>{s.r(e),s.d(e,{default:()=>m});var r=s(2376),a=s(2904),o=s(629),i=s(5714),n=s(8181);function l(t){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l(t)}function c(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,r)}return s}function d(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const u={layout:"backend",middleware:["auth"],components:{ContentHeader:r.Z,ContentBody:a.Z,Notification:n.Z},metaInfo:function(){return{title:"Éxecution de la mission"}},data:function(){return{rowSelected:null,currentMetadata:{},isCompleted:!1,details:[],process:null,mission:null,form:new i.ZP({rows:[]})}},computed:function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?c(Object(s),!0).forEach((function(e){d(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({formErrorsCount:function(){return Object.entries(this.form.errors.all()).length}},(0,o.Se)({config:"details/config"})),breadcrumb:function(){var t;return{label:null===(t=this.process)||void 0===t?void 0:t.name}},created:function(){this.initData()},methods:{show:function(t){this.rowSelected=t,this.currentMetadata.keys=Object.keys(t.parsed_metadata)},close:function(){this.rowSelected=null},switchToExeMode:function(){this.isCompleted=!1,this.initData(!1),this.initForm()},initData:function(){var t=this,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$store.dispatch("details/fetchConfig",{missionId:this.$route.params.missionId,processId:this.$route.params.processId}).then((function(){t.details=t.config.config.details,t.mission=t.config.config.mission,t.process=t.config.config.process,null!==t.details[0].executed_at?t.isCompleted=e:t.initForm()}))},initForm:function(){var t=this;this.details.forEach((function(e){t.form.rows.push({detail:e.id,report:e.report,recovery_plan:e.recovery_plan,score:e.score,major_fact:!!e.major_fact,metadata:e.metadata||[]})}))},setupFields:function(t){return t.map((function(t){return{type:t[0].type,label:t[1].label,name:t[2].name,length:t[3].length,style:t[4].style,id:t[5].id,placeholder:t[6].placeholder,help_text:t[7].help_text}}))},setupScores:function(t){return"object"==l(t)?t.map((function(t){return{id:t[0].score,label:t[1].label}})):[]},create:function(){var t=this;this.form.post("/api/missions/details/"+this.mission.id).then((function(e){e.data.status?(swal.toast_success(e.data.message),t.initData()):swal.alert_error(e.data.message)})).catch((function(t){var e=t.message;422==t.response.status&&(e="Les données fournies sont invalides."),swal.toast_error(e)}))},addRow:function(t,e){e=this.setupFields(e);for(var s=[],r=0;r<e.length;r++){var a,o=e[r],i=o.name,n=void 0!==o.default&&o.default;n=o.multiple?[]:"",s.push((d(a={},i,n),d(a,"label",o.label),a))}this.form.rows[t].metadata&&this.form.rows[t].metadata.push(s)},removeRow:function(t,e){this.form.rows[t].metadata.splice(e,1)},isInput:function(t){return["text","date","datetime","time","week","number","tel","email","month","url"].includes(t)}}};const m=(0,s(1900).Z)(u,(function(){var t=this,e=t._self._c;return t.isCompleted?e("div",{directives:[{name:"can",rawName:"v-can",value:"view_mission",expression:"'view_mission'"}]},[e("ContentHeader",{scopedSlots:t._u([{key:"actions",fn:function(){return[e("button",{directives:[{name:"can",rawName:"v-can",value:"edit_mission,control_agency",expression:"'edit_mission,control_agency'"}],staticClass:"btn btn-warning my-6",on:{click:function(e){return t.switchToExeMode()}}},[e("i",{staticClass:"las la-pen"})])]},proxy:!0}])}),t._v(" "),e("ContentBody",[e("div",{staticClass:"grid"},t._l(t.details,(function(s){return e("div",{key:s.id,staticClass:"col-12"},[e("div",{staticClass:"box"},[e("div",{staticClass:"grid gap-4"},[e("div",{staticClass:"col-12"},[e("div",{staticClass:"tags"},[e("span",{staticClass:"tag is-info"},[t._v(t._s(s.familly.name))]),t._v(" "),e("span",{staticClass:"tag"},[t._v(t._s(s.domain.name))]),t._v(" "),e("span",{staticClass:"tag is-warning"},[t._v(t._s(s.process.name))])])]),t._v(" "),e("div",{staticClass:"col-12"},[e("h3",[t._v(t._s(s.control_point.name))])]),t._v(" "),e("div",{staticClass:"col-4"},[e("b",[t._v("Fait majeur:")])]),t._v(" "),e("div",{staticClass:"col-8"},[s.major_fact?e("span",[e("i",{staticClass:"las la-times-circle icon text-danger"}),t._v("\n                Oui\n              ")]):e("span",[e("i",{staticClass:"las la-check-circle icon text-success"}),t._v("\n                Non\n              ")])]),t._v(" "),e("div",{staticClass:"col-4"},[e("b",[t._v("Appréciation:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s(s.appreciation))]),t._v(" "),e("div",{staticClass:"col-4"},[e("b",[t._v("Constat:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s(s.report||"-"))]),t._v(" "),e("div",{staticClass:"col-4"},[e("b",[t._v("Plan de redressement:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s(s.recovery_plan||"-"))]),t._v(" "),e("div",{staticClass:"col-12 d-flex justify-end align-center"},[e("button",{staticClass:"btn btn-info has-icon",on:{click:function(e){return t.show(s)}}},[e("i",{staticClass:"las la-eye icon"}),t._v("\n                Voir plus\n              ")])])])])])})),0),t._v(" "),e("NLModal",{attrs:{show:t.rowSelected},on:{close:t.close},scopedSlots:t._u([{key:"title",fn:function(){var s,r,a;return[e("small",{staticClass:"tag is-info text-small"},[t._v("\n          "+t._s(null===(s=t.rowSelected)||void 0===s?void 0:s.familly.name)+"\n        ")]),t._v(" "),e("small",{staticClass:"tag is-primary-dark text-small mx-1"},[t._v("\n          "+t._s(null===(r=t.rowSelected)||void 0===r?void 0:r.domain.name)+"\n        ")]),t._v(" "),e("small",{staticClass:"tag is-warning text-small"},[t._v("\n          "+t._s(null===(a=t.rowSelected)||void 0===a?void 0:a.process.name)+"\n        ")])]},proxy:!0},{key:"default",fn:function(){var s,r,a,o,i,n,l,c,d;return[e("p",{staticClass:"text-bold mb-6"},[t._v("\n          "+t._s(null===(s=t.rowSelected)||void 0===s?void 0:s.control_point.name)+"\n        ")]),t._v(" "),e("div",{staticClass:"grid list"},[e("div",{staticClass:"col-12 list-item"},[e("div",{staticClass:"list-item-content no-bg grid"},[e("div",{staticClass:"col-4"},[e("b",[t._v("Fait majeur:")])]),t._v(" "),e("div",{staticClass:"col-8"},[null!==(r=t.rowSelected)&&void 0!==r&&r.major_fact?e("span",[e("i",{staticClass:"las la-times-circle icon text-danger"}),t._v("\n                  Oui\n                ")]):e("span",[e("i",{staticClass:"las la-check-circle icon text-success"}),t._v("\n                  Non\n                ")])])])]),t._v(" "),e("div",{staticClass:"col-12 list-item"},[e("div",{staticClass:"list-item-content no-bg grid"},[e("div",{staticClass:"col-4"},[e("b",[t._v("Appréciation:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s(null===(a=t.rowSelected)||void 0===a?void 0:a.appreciation))])])]),t._v(" "),e("div",{staticClass:"col-12 list-item"},[e("div",{staticClass:"list-item-content no-bg grid"},[e("div",{staticClass:"col-4"},[e("b",[t._v("Constat:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s((null===(o=t.rowSelected)||void 0===o?void 0:o.report)||"-"))])])]),t._v(" "),e("div",{staticClass:"col-12 list-item"},[e("div",{staticClass:"list-item-content no-bg grid"},[e("div",{staticClass:"col-4"},[e("b",[t._v("Plan de redressement:")])]),t._v(" "),e("div",{staticClass:"col-8"},[t._v(t._s((null===(i=t.rowSelected)||void 0===i?void 0:i.recovery_plan)||"-"))])])]),t._v(" "),e("div",{staticClass:"col-12 list-item"},[e("div",{staticClass:"list-item-content no-bg grid"},[e("div",{staticClass:"col-12",class:{"col-lg-4":!(null!==(n=t.rowSelected)&&void 0!==n&&n.metadata)}},[e("b",[t._v("Informations supplémentaires:")])]),t._v(" "),e("div",{staticClass:"col-12",class:{"col-lg-8":!(null!==(l=t.rowSelected)&&void 0!==l&&l.metadata)}},[null!==(c=t.rowSelected)&&void 0!==c&&c.metadata?e("table",[e("thead",[e("tr",t._l(t.currentMetadata.keys,(function(s){return e("th",{staticClass:"text-left"},[t._v("\n                        "+t._s(s)+"\n                      ")])})),0)]),t._v(" "),e("tbody",t._l(null===(d=t.rowSelected)||void 0===d?void 0:d.metadata,(function(s,r){return e("tr",{key:"metadata-row-"+r},t._l(s,(function(s,a){return e("td",{key:"metadata-row-"+r+"-item-"+a,staticClass:"text-left"},t._l(s,(function(s,o){return"label"!==o?e("span",{key:"metadata-row-"+r+"-item-"+a+"-content"},[t._v("\n                          "+t._s(s)+"\n                        ")]):t._e()})),0)})),0)})),0)]):e("span",[t._v("-")])])])])])]},proxy:!0}])})],1)],1):e("ContentBody",{directives:[{name:"can",rawName:"v-can",value:"control_agency",expression:"'control_agency'"}]},[t.form.errors.any()?e("Notification",{attrs:{type:"is-danger"}},[t._v("\n    Il y a "+t._s(t.formErrorsCount)+"\n    "+t._s(t.formErrorsCount>1?"problèmes avec vos entrées":"problème avec une entrée")+".\n  ")]):t._e(),t._v(" "),e("form",{on:{submit:function(e){return e.preventDefault(),t.create.apply(null,arguments)},keydown:function(e){return t.form.onKeydown(e)}}},[t._l(t.details,(function(s,r){return e("div",{key:"detail-"+r,staticClass:"grid my-2 form-row"},[e("div",{staticClass:"col-10"},[e("h2",{staticClass:"text-medium"},[t._v(t._s(null==s?void 0:s.control_point.name))])]),t._v(" "),e("div",{staticClass:"col-2"},[e("NLSwitch",{attrs:{name:"rows."+r+".major_fact",form:t.form,label:"Fait majeur"},model:{value:t.form.rows[r].major_fact,callback:function(e){t.$set(t.form.rows[r],"major_fact",e)},expression:"form.rows[row].major_fact"}})],1),t._v(" "),e("div",{staticClass:"col-12"},[e("NLSelect",{attrs:{name:"rows."+r+".score",label:"Notation",form:t.form,options:t.setupScores(s.control_point.scores),labelRequired:""},model:{value:t.form.rows[r].score,callback:function(e){t.$set(t.form.rows[r],"score",e)},expression:"form.rows[row].score"}})],1),t._v(" "),s.control_point.fields?e("div",{staticClass:"col-12"},[e("div",{staticClass:"repeater"},[e("h2",{staticClass:"mb-6"},[t._v("Informations supplémentaires")]),t._v(" "),t._l(t.form.rows[r].metadata,(function(a,o){return e("div",{key:"metadata-"+o+"row-"+r,staticClass:"grid my-6 repeater-row"},[e("div",{staticClass:"col-12"},[e("div",{staticClass:"grid gap-2"},[e("div",{staticClass:"col-11"},[e("div",{staticClass:"grid"},t._l(t.setupFields(s.control_point.fields),(function(s,a){return e("div",{key:"metadata-input-"+s.name+"-"+o+"-id",class:s.style},[t.isInput(s.type)?e("NLInput",{attrs:{form:t.form,label:s.label,placeholder:s.placeholder,type:s.type,labelRequired:s.required,name:"rows."+r+".metadata."+o+"."+s.name,id:"rows."+o+"."+s.name},model:{value:t.form.rows[r].metadata[o][a][s.name],callback:function(e){t.$set(t.form.rows[r].metadata[o][a],s.name,e)},expression:"form.rows[row].metadata[dataRow][index][input.name]"}}):t._e(),t._v(" "),"textarea"==s.type?e("NLTextarea",{attrs:{form:t.form,label:s.label,placeholder:s.placeholder,type:s.type,labelRequired:s.required,name:"rows."+r+".metadata."+o+"."+s.name,id:"rows."+o+"."+s.name,length:s.length},model:{value:t.form.rows[r].metadata[o][a][s.name],callback:function(e){t.$set(t.form.rows[r].metadata[o][a],s.name,e)},expression:"form.rows[row].metadata[dataRow][index][input.name]"}}):t._e(),t._v(" "),"wyswyg"==s.type?e("NLWyswyg",{attrs:{form:t.form,label:s.label,placeholder:s.placeholder,type:s.type,labelRequired:s.required,name:"rows."+r+".metadata."+o+"."+s.name,id:"rows."+o+"."+s.name,length:s.length},model:{value:t.form.rows[r].metadata[o][a][s.name],callback:function(e){t.$set(t.form.rows[r].metadata[o][a],s.name,e)},expression:"form.rows[row].metadata[dataRow][index][input.name]"}}):t._e(),t._v(" "),"select"==s.type?e("NLSelect",{attrs:{form:t.form,label:s.label,type:s.type,labelRequired:s.required,name:"rows."+r+".metadata."+o+"."+s.name,id:"rows."+o+"."+s.name,options:s.options,placeholder:s.placeholder||"Choisissez une option...",multiple:s.multiple},model:{value:t.form.rows[r].metadata[o][a][s.name],callback:function(e){t.$set(t.form.rows[r].metadata[o][a],s.name,e)},expression:"form.rows[row].metadata[dataRow][index][input.name]"}}):t._e()],1)})),0)]),t._v(" "),r>=0?e("div",{staticClass:"col-1 p-0 d-flex justify-start align-center"},[e("div",{staticClass:"btn btn-danger",on:{click:function(e){return t.removeRow(r,o)}}},[t._v("\n                    Supprimer\n                  ")])]):t._e()])])])})),t._v(" "),e("div",{staticClass:"d-flex justify-start align-center"},[e("span",{staticClass:"btn",on:{click:function(e){return t.addRow(r,s.control_point.fields)}}},[e("i",{staticClass:"las la-plus"})])])],2)]):t._e(),t._v(" "),e("div",{staticClass:"col-12"},[e("NLTextarea",{attrs:{name:"rows."+r+".report",label:"Constat",form:t.form,placeholder:1==t.form.rows[r].score||null==t.form.rows[r].score?"":"Ajouter votre constat",labelRequired:"",disabled:1==t.form.rows[r].score||null==t.form.rows[r].score},model:{value:t.form.rows[r].report,callback:function(e){t.$set(t.form.rows[r],"report",e)},expression:"form.rows[row].report"}})],1),t._v(" "),e("div",{staticClass:"col-12"},[e("NLTextarea",{attrs:{name:"rows."+r+".recovery_plan",label:"Plan de redressement",form:t.form,placeholder:1==t.form.rows[r].score||null==t.form.rows[r].score?"":"Ajouter votre plan de redressement",labelRequired:"",disabled:1==t.form.rows[r].score||null==t.form.rows[r].score},model:{value:t.form.rows[r].recovery_plan,callback:function(e){t.$set(t.form.rows[r],"recovery_plan",e)},expression:"form.rows[row].recovery_plan"}})],1)])})),t._v(" "),e("div",{staticClass:"d-flex justify-end align-center"},[e("NLButton",{staticClass:"is-radius",attrs:{loading:t.form.busy,label:"Save"}})],1)],2)],1)}),[],!1,null,null,null).exports}}]);